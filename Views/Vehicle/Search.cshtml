@inject ApplicationDbContext context;
@model List<VehicleListing>;

@{
    ViewData["Title"] = "Search";
}

<div class="text-center">
    <h3>Vehicle announcements</h3>
</div>


<div class="row">
    <div class="col-4">
        <h2>Search</h2>
        <div class="mb-3">
            <form method="post" asp-action="Filter">
                <div class="row">
                    <div class="col-8">
                        <input class="form-control me-2" type="search" placeholder="Search" aria-label="Search">
                    </div>
                    <div class="col-4">
                        <button class="btn btn-secondary" type="submit">Search</button>
                    </div>
                </div>
            </form>
        </div>

        <h2>Filter</h2>
        <form id="filter-form">
            <div class="form-group">
                <label for="make">Make:</label>
                <select class="form-control" id="make" name="make">
                    <option value="all">All Makes</option>
                    <option value="toyota">Toyota</option>
                    <option value="honda">Honda</option>
                    <option value="ford">Ford</option>
                    <!-- Add more options as needed -->
                </select>
            </div>

            <div class="form-group">
                <label for="model">Model:</label>
                <select class="form-control" id="model" name="model">
                    <option value="all">All Models</option>
                    <!-- Options will be populated dynamically based on selected make -->
                </select>
            </div>

            <div class="form-group">
                <label for="price">Price Range:</label>
                <input type="range" class="form-control-range" id="price" name="price" min="0" max="50000" step="1000" value="0">
                <span id="price-output">$0</span>
            </div>
            
            <button type="submit" class="btn btn-primary">Apply Filters</button>
        </form>
    </div>

    <div class="col-7">
        @{var pageSize = 10; // Number of listings per page
            var totalListings = context.VehicleListings.Count();
            var totalPages = (int)Math.Ceiling((double)totalListings / pageSize);
            int currentPage = ViewBag.Page != null ? (int)ViewBag.Page : 1;

            var listings = context.VehicleListings.Skip((currentPage - 1) * pageSize).Take(pageSize);
        }

        @{foreach(var item in Model){
            <div class="card mb-3 mx-auto" style="max-width: 540px;">
                <div class="row g-0">
                    <div class="col-md-4">
                        @{foreach(var ogg in context.VehicleImages){
                            if(ogg.VehicleId == item.VehicleId){
                                <img src="~/Images/@ogg.Path" class="img-fluid rounded-start" alt="">
                                break;
                            }
                        }}
                    </div>
                    <div class="col-md-8">
                        <div class="card-body">
                            @{foreach(var ogg in context.Vehicles){
                                if(ogg.VehicleId == item.VehicleId){
                                    <h5 class="card-title">@ogg.Title</h5>
                                    <p class="card-text">@ogg.Description<br>@ogg.Priceâ‚¬</p>
                                    <p class="card-text"><small class="text-muted">@ogg.RegistrationMonth/@ogg.RegistrationYear &nbsp; @ogg.Mileage km &nbsp; @ogg.Fuel &nbsp; @ogg.Transmission </small></p>
                                    break;
                                }
                            }}
                        </div>
                    </div>
                </div>
            </div>
        }}
        <nav aria-label="Page navigation">
            <ul class="pagination justify-content-center">
                @for (int i = 1; i <= totalPages; i++){
                    <li class="page-item @(i == ViewBag.Page ? "active" : "")">
                        <a class="page-link" href="@Url.Action("Search", new { page = i })">@i</a>
                    </li>
                }
            </ul>
        </nav>
    </div>
</div>

<script>
    document.addEventListener("DOMContentLoaded", function() {
    // Populate model dropdown based on selected make
        document.getElementById("make").addEventListener("change", function() {
            var selectedMake = this.value;
            var modelSelect = document.getElementById("model");
            // Clear existing options
            modelSelect.innerHTML = '';
            // Add new options based on selected make
            if (selectedMake === "toyota") {
                modelSelect.innerHTML += '<option value="camry">Camry</option>';
                modelSelect.innerHTML += '<option value="corolla">Corolla</option>';
            } else if (selectedMake === "honda") {
                modelSelect.innerHTML += '<option value="accord">Accord</option>';
                modelSelect.innerHTML += '<option value="civic">Civic</option>';
            } else if (selectedMake === "ford") {
                modelSelect.innerHTML += '<option value="focus">Focus</option>';
                modelSelect.innerHTML += '<option value="mustang">Mustang</option>';
            }
        });

        // Display selected price range
        document.getElementById("price").addEventListener("input", function() {
            document.getElementById("price-output").innerText = '$' + this.value;
        });
    });
</script>